<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>
    <template id="report_bank_statement_template">
      <t t-call="web.html_container">
        <t t-foreach="docs" t-as="o">
          <t t-call="web.basic_layout">
            <div class="header" style="margin-bottom:0;">
              <link rel="stylesheet" href='/bank_reconciliation/static/src/css/header.css'/>
              <div class="col-8 pull-left">
                <t t-if="o.company_id.logo">
                    <img t-att-src="'data:image/png;base64,%s' % o.company_id.logo.decode('utf-8')"
                          style="position:absolute; margin-top: 1cm; width: 100px; height: auto;"/>
                </t>
                <t t-else=""></t>
              </div>
              <!-- Fecha y paginacion -->
              <br></br>
              <div class="datoscompa">
                <p style="margin:0; padding:0;"><span t-field="o.company_id.name"/></p>
                <p style="margin:0; padding:0;"><span t-field="o.company_id.street"/></p>
                <p style="margin:0; padding:0;"><span t-field="o.company_id.city"/></p>
                <p style="margin:0; padding:0;"><span t-field="o.company_id.country_id.name"/></p>
                <p style="margin:0; padding:0;">
                  <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d/%m/%Y %H:%M')"/>
                </p>
                <p style="margin:0; padding:0;">
                  <span>Pag: </span><span class="page"/> de <span class="topage"/>
                </p>
              </div>
            </div>
            <br></br>
            <!-- Filtros -->
            <div class="filtros" style="margin-left:0; text-align:left;">
              <p id="titulos" style="margin:0; padding:0; font-weight:bold; font-size:12px;">
                Reporte de Conciliación
              </p>
              <p id="titulos" style="margin:0; padding:0;">Usuario: <span t-field="user.name"/></p>
              <p id="titulos" style="margin:0; padding:0;">Banco: <span t-field="o.journal_id"/></p>
              <p id="titulos" style="margin:0; padding:0;">Cuenta: <span t-field="o.account_id"/></p>
              <p id="titulos" style="margin:0; padding:0;">
                Fecha desde: <span t-field="o.date_from"/> hasta: <span t-field="o.date_to"/>
              </p>
            </div>

            <link rel="stylesheet" href='/bank_reconciliation/static/src/css/statement.css'/>
            <br></br>

            <!-- Tabla principal de movimientos -->
            <div class="page">
              <div class="contenedor">
                <div>
                  <!-- Se puede incluir información extra si se desea -->
                </div>
                <br></br>
                <table class="tabla">
                  <!-- Usamos <thead> con display: table-row-group para evitar repetición en saltos de línea -->
                  <thead style="display: table-row-group;">
                    <tr>
                      <th style="width:20%; text-align:left; vertical-align:bottom;">Empresa</th>
                      <th style="width:20%; text-align:left; vertical-align:bottom;">Referencia</th>
                      <th style="width:20%; text-align:left; vertical-align:bottom;">Descripción</th>
                      <th style="width:10%; text-align:right; vertical-align:bottom;">Fecha contable</th>
                      <th style="width:10%; text-align:right; vertical-align:bottom;">Fecha de extracto</th>
                      <th style="width:10%; text-align:right; vertical-align:bottom;">Débito</th>
                      <th style="width:10%; text-align:right; vertical-align:bottom;">Crédito</th>
                    </tr>
                     <t t-if="o.saldo_anterior_informe != 0">
                          <tr>
                              <th colspan="6" style="text-align:left;">Saldo Inicial</th>
                              <th><span t-field="o.saldo_anterior_informe"/></th>
                          </tr>
                      </t>
                  </thead>
                  <t t-set="saldo_anterior" t-value="0"/>
                  <t t-set="monto_actual" t-value="0"/>
                  <t t-foreach="o.account_mvl_object().filtered(
                        lambda l: (l.statement_date and (l.statement_date &gt;= o.date_from and l.statement_date &lt;= o.date_to))
                                  or ((not l.statement_date) and l.date and (l.date &gt;= o.date_from and l.date &lt;= o.date_to))
                      )" t-as="lines">
                    <tbody>
                      <t t-if="'USD' in o.account_id.name">
                        <!-- Bloque para USD -->
                        <td style="width:20%; text-align:left; vertical-align:bottom;">
                          <span t-field="lines.partner_id"/>
                        </td>
                        <td style="width:20%; text-align:left; vertical-align:bottom;">
                          <span t-field="lines.ref"/>
                        </td>
                        <td style="width:20%; text-align:left; vertical-align:bottom;">
                          <span t-field="lines.descripcion"/>
                        </td>
                        <td style="width:10%; text-align:right; vertical-align:bottom;">
                          <span t-field="lines.date"/>
                        </td>
                        <td style="width:10%; text-align:right; vertical-align:bottom;">
                          <span t-field="lines.statement_date"/>
                        </td>
                        <td style="width:10%; text-align:right; vertical-align:bottom;">
                          <t t-if="lines.credit != 0.0">
                            <span t-esc="lines.currency_id.symbol"/>
                            <span t-field="lines.credito_abs"/>
                          </t>
                        </td>
                        <td style="width:10%; text-align:right; vertical-align:bottom;">
                          <t t-if="lines.debit != 0.0">
                            <span t-esc="lines.currency_id.symbol"/>
                            <span t-field="lines.debito_abs"/>
                          </t>
                        </td>
                      </t>
                      <t t-else="">
                        <!-- Bloque para otras monedas -->
                        <td style="width:20%; text-align:left; vertical-align:bottom;">
                          <span t-field="lines.partner_id"/>
                        </td>
                        <td style="width:20%; text-align:left; vertical-align:bottom;">
                          <span t-field="lines.ref"/>
                        </td>
                        <td style="width:20%; text-align:left; vertical-align:bottom;">
                          <span t-field="lines.descripcion"/>
                        </td>
                        <td style="width:10%; text-align:right; vertical-align:bottom;">
                          <span t-field="lines.date"/>
                        </td>
                        <td style="width:10%; text-align:right; vertical-align:bottom;">
                          <span t-field="lines.statement_date"/>
                        </td>
                        <td style="width:10%; text-align:right; vertical-align:bottom;">
                          <t t-if="lines.credito_abs != 0.0">
                            <span t-esc="o.agregar_punto_de_miles(lines.credit, o.currency_id.name)"/>
                          </t>
                        </td>
                        <td style="width:10%; text-align:right; vertical-align:bottom;">
                          <t t-if="lines.debito_abs != 0.0">
                            <span t-esc="o.agregar_punto_de_miles(lines.debit, o.currency_id.name)"/>
                          </t>
                        </td>
                      </t>
                    </tbody>
                  </t>
                  <tfoot>
                  </tfoot>
                </table>
                <br/>
                <br/>
                <br/>
              </div>

              <!-- La(s) siguientes tablas, si no deben duplicar encabezados al saltar de línea,
                   se les aplica también el estilo en el <thead> -->
              <div class="contenedor2">
                <t t-set="movimientos" t-value="o.account_mvl_object().filtered(
                      lambda l: (l.statement_date and (l.statement_date &gt;= o.date_from and l.statement_date &lt;= o.date_to))
                                or ((not l.statement_date) and l.date and (l.date &gt;= o.date_from and l.date &lt;= o.date_to))
                    )"/>
                <t t-set="saldo_final_filtrado" t-value="movimientos and movimientos[-1].saldo or 0"/>
                <t t-set="saldo_conciliado_filtrado"
                   t-value="o.saldo_anterior_informe + sum((m.debito_abs + m.credito_abs) for m in o.account_mvl_object().filtered(
                      lambda l: l.statement_date and (l.statement_date &gt;= o.date_from and l.statement_date &lt;= o.date_to)
                    ))"/>
                <t t-set="diferencia_filtrado" t-value="saldo_final_filtrado - saldo_conciliado_filtrado"/>
                <t t-set="diferencia_nuevo" t-value="o.saldo_final_informe - o.saldo_inicial"/>
                <table class="saldos" style="width:70%; margin-bottom:30px; font-size:10px;">
                  <thead style="display: table-row-group;">
                    <t t-if="'USD' in o.account_id.name">
                      <tr>
                        <th>Saldo en el libro banco de la compañia : </th>
                        <td>
                          <span t-esc="o.agregar_punto_de_miles(o.saldo_final_informe, o.currency_id.name)"/>
                        </td>
                      </tr>
                      <tr>
                        <th>Saldo Conciliado en el libro banco : </th>
                        <td>
                          <span t-esc="o.agregar_punto_de_miles(abs(o.saldo_inicial or 0), o.currency_id.name)"/>
                        </td>
                      </tr>
                      <tr>
                        <th>Diferencia : </th>
                        <td>
                          <span t-esc="o.agregar_punto_de_miles(diferencia_nuevo, o.currency_id.name)"/>
                        </td>
                      </tr>
                    </t>
                    <t t-else="">
                      <tr>
                        <th>Saldo en el libro banco de la compañia : </th>
                        <td>
                          <span t-esc="o.agregar_punto_de_miles(o.saldo_final_informe, o.currency_id.name)"/>
                        </td>
                      </tr>
                      <tr>
                        <th>Saldo Conciliado en el libro banco : </th>
                        <td>
                          <span t-esc="o.agregar_punto_de_miles(abs(o.saldo_inicial or 0), o.currency_id.name)"/>
                        </td>
                      </tr>
                      <tr>
                        <th>Diferencia : </th>
                        <td>
                        <span t-esc="o.agregar_punto_de_miles(abs(diferencia_nuevo), o.currency_id.name)"/>
                        </td>
                      </tr>
                    </t>
                  </thead>
                  <br/>
                  <br/>
                </table>
                <t t-set="movimientos" t-value="o.account_mvl_object().filtered(
                      lambda l: (l.statement_date and (l.statement_date &gt;= o.date_from and l.statement_date &lt;= o.date_to))
                                or ((not l.statement_date) and l.date and (l.date &gt;= o.date_from and l.date &lt;= o.date_to))
                    )"/>
                <table class="tabla" style="width:70%; margin-bottom:30px; font-size:10px;">
                  <thead style="display: table-row-group;">
                    <tr>
                      <th colspan="4" style="text-align:left;">
                        <span style="padding-left: 5px;">Apuntes no reflejados en el extracto bancario</span>
                      </th>
                    </tr>
                    <tr>
                      <th style="text-align:left; vertical-align:bottom;">Fecha contable</th>
                      <th style="text-align:left;">Referencia</th>
                      <th style="text-align:right; vertical-align:bottom;">Débito</th>
                      <th style="text-align:right; vertical-align:bottom;">Crédito</th>
                    </tr>
                  </thead>
                  <tbody>
                    <t t-set="total_debito" t-value="0"/>
                    <t t-set="total_credito" t-value="0"/>
                    <t t-foreach="o.get_all_pending_lines()" t-as="line">
                      <tr>
                        <td style="text-align:left; vertical-align:bottom;">
                          <span t-field="line.date"/>
                        </td>
                        <td style="text-align:left;">
                          <span t-field="line.ref"/>
                        </td>
                        <td style="text-align:right; vertical-align:bottom;">
                          <span t-esc="o.agregar_punto_de_miles(abs(line.credito), o.currency_id.name)"/>
                          <t t-set="total_debito" t-value="total_debito + abs(line.credito)"/>
                        </td>
                        <td style="text-align:right; vertical-align:bottom;">
                          <span t-esc="o.agregar_punto_de_miles(abs(line.debito), o.currency_id.name)"/>
                          <t t-set="total_credito" t-value="total_credito + abs(line.debito)"/>
                        </td>
                      </tr>
                    </t>
                    <tr>
                      <td colspan="2" style="text-align:right; padding-right:5px;">
                        <strong>Totales:</strong>
                      </td>
                      <td style="text-align:right; vertical-align:bottom;">
                        <span t-esc="o.agregar_punto_de_miles(total_debito, o.currency_id.name)"/>
                      </td>
                      <td style="text-align:right; vertical-align:bottom;">
                        <span t-esc="o.agregar_punto_de_miles(total_credito, o.currency_id.name)"/>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <t t-if="o.imported_line_ids">
                  <table class="tabla" style="width:70%; margin-bottom:30px; font-size:10px;">
                    <thead style="display: table-row-group;">
                      <tr>
                        <th colspan="4" style="text-align:left;">
                          <span style="padding-left: 5px;">Apuntes no reflejados en el sistema</span>
                        </th>
                      </tr>
                      <tr>
                        <th style="text-align:left; vertical-align:bottom;">Fecha contable</th>
                        <th style="text-align:left;">Número de Operación según Extracto Bancario</th>
                        <th style="text-align:right; vertical-align:bottom;">Débito (A)</th>
                        <th style="text-align:right; vertical-align:bottom;">Crédito (B)</th>
                      </tr>
                    </thead>
                    <tbody>
                      <t t-set="total_debito_import" t-value="0"/>
                      <t t-set="total_credito_import" t-value="0"/>
                      <t t-foreach="o.imported_line_ids" t-as="line">
                        <tr>
                          <td style="text-align:left; vertical-align:bottom;">
                            <span t-field="line.date"/>
                          </td>
                          <td style="text-align:left;">
                            <span t-field="line.ref"/>
                          </td>
                          <td style="text-align:right; vertical-align:bottom;">
                            <span t-esc="o.agregar_punto_de_miles(line.debit, o.currency_id.name)"/>
                            <t t-set="total_debito_import" t-value="total_debito_import + line.debit"/>
                          </td>
                          <td style="text-align:right; vertical-align:bottom;">
                            <span t-esc="o.agregar_punto_de_miles(line.credit, o.currency_id.name)"/>
                            <t t-set="total_credito_import" t-value="total_credito_import + line.credit"/>
                          </td>
                        </tr>
                      </t>
                      <tr>
                        <td colspan="2" style="text-align:right; padding-right:5px;">
                          <strong>Totales:</strong>
                        </td>
                        <td style="text-align:right; vertical-align:bottom;">
                          <span t-esc="o.agregar_punto_de_miles(total_debito_import, o.currency_id.name)"/>
                        </td>
                        <td style="text-align:right; vertical-align:bottom;">
                          <span t-esc="o.agregar_punto_de_miles(total_credito_import, o.currency_id.name)"/>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </t>
                <t t-if="o.imprimir_responsable">
                  <table style="width: 40%; border: 1px solid black; border-collapse: collapse;">
                    <tr style="height: 90px;">
                      <td style="border: 1px solid black;"><span></span></td>
                    </tr>
                    <tr>
                      <td style="border: 1px solid black;">
                        <strong><p>Responsable de Conciliación</p></strong>
                        <p>Aclaración:</p>
                      </td>
                    </tr>
                  </table>
                </t>
              </div>
            </div>
          </t>
        </t>
      </t>
    </template>
  </data>
</odoo>
